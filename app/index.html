<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Vanilla JavaScript App</title>
</head>

<body>
  <main>
    <h1 id="title">Get Random Album</h1>
  </main>

  <template id="login-template">
    <div id="spotifylogin">
      <p>First log into your Spotify account.</p>
      <button onclick="login();">Login to Spotify</button>
    </div>
  </template>

  <template id="get-album-template">
    <div id="get-album">
      <p>Get a random album from your Spotify library.</p>
      <button onclick="getAlbum();">Get Album</button>
    </div>
  </template>

  <script>
    function getHashParams() {
      var hashParams = {};
      var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
      while (e = r.exec(q)) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
      }
      return hashParams;
    }

    function login() {
      window.location = 'api/login';
    }

    async function getAlbumInfo() {
      const response = await fetch('api/getrandomalbum')
      const data = await response.json()
      console.log(data)
      return data
    }

    async function getAlbum() {
      const album = await getAlbumInfo()
      const albumElement = generateAlbumMarkdown(album)

      // If album element exists replace contents
      if(checkElementExists('album')){
        let album = document.getElementById('album')
        album.replaceWith(albumElement)
      }

      removeElement('get-album')
      const main = document.querySelector('main')
      main.append(albumElement)
    }

    function checkElementExists(name){
      const element = document.getElementById(name)
      if (!element) {
        return false
      }
      return true
    }

    function removeElement(name) {
      let element = document.getElementById(name)
      if (element) {
        element.parentNode.removeChild(element)
      }
    }

    function generateAlbumMarkdown(album) {
      // TODO check number of items
      // TODO add multiple artists
      // TODO add album type (album, comp, EP, etc)
      const albumDetails = album.items[0].album            
      const markup = `
        <h2>Album Details</h2>
        <p>Artist(s): ${albumDetails.artists[0].name}</p>
        <p>Title: ${albumDetails.name}</p>
        <p>Label: ${albumDetails.label}</P>
        <p>Released: ${albumDetails.release_date}</p>
        <img src="${albumDetails.images[1].url}"/>
        <div>
          <button onclick="getAlbum();" id="getAnotherAlbum">Get Another Album</button>
        </div>
      `
      let container = document.createElement('div')
      container.setAttribute('id', "album")
      container.innerHTML = markup
      return container
    }

    function getConditionalAuthContent(status) {
      console.log(status)
      if (status != 'success') {
        return document.getElementById('login-template')
      }

      return document.getElementById('get-album-template')
    }

    const params = getHashParams()
    const main = document.querySelector('main')
    const conditionalContent = getConditionalAuthContent(params.authstatus)
    const fetchingNode = document.importNode(conditionalContent.content, true);
    main.append(fetchingNode)

  </script>
</body>

</html>